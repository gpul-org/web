---
import Loader from "lucide-astro/Loader";
import Check from "lucide-astro/Check";
import SimpleInput from "./SimpleIntput.astro";

const { class: className } = Astro.props;
---

<div
  class={`bg-gray-100 dark:bg-neutral-800 rounded-2xl p-8 m-auto h-fit ${className}`}
>
  <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
    Envíanos unha mensaxe
  </h2>

  <form id="contact-form" class="space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <SimpleInput name="name" type="text" placeholder="O teu nome">
        Nome
      </SimpleInput>
      <SimpleInput name="surname" type="text" placeholder="Os teus apelidos">
        Apelidos
      </SimpleInput>
      <SimpleInput
        name="phone"
        type="tel"
        placeholder="123456789"
        class="phone"
      >
        Teléfono
      </SimpleInput>
      <SimpleInput name="mail" type="email" placeholder="teu@email.com">
        Email
      </SimpleInput>
    </div>

    <div>
      <SimpleInput
        name="subject"
        type="select"
        placeholder={[
          { value: "", text: "Selecciona un asunto" },
          { value: "socio", text: "Quero ser socio" },
          { value: "evento", text: "Consulta sobre eventos" },
          { value: "colaboracion", text: "Proposta de colaboración" },
          { value: "charla", text: "Propor charla/taller" },
          { value: "outro", text: "Outro" },
        ]}
      >
        Asunto
      </SimpleInput>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <SimpleInput name="dni" type="text" placeholder="12345678A">
        DNI/NIE/Pasaporte
      </SimpleInput>
      <SimpleInput name="birth" type="date"> Data de nacemento </SimpleInput>
      <SimpleInput name="address" type="text"> Enderezo completo </SimpleInput>
      <SimpleInput
        name="occupation"
        type="text"
        placeholder="Grao en Enxeñaría Informática"
      >
        Profesión ou carreira que estás a estudar
      </SimpleInput>

      <SimpleInput name="udc-student" type="checkbox" required={false}>
        Estudas na UDC
      </SimpleInput>
    </div>
    <SimpleInput
      name="message"
      type="textarea"
      placeholder="Escribe aquí a túa mensaxe..."
    >
      Mensaxe
    </SimpleInput>

    <SimpleInput name="privacy-policy" type="checkbox">
      Acepto a <a
        href="#"
        class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300"
        >política de privacidade</a
      >
    </SimpleInput>

    <button
      type="submit"
      class="w-full bg-blue-600 dark:bg-blue-400 text-white py-3 px-4 rounded-md hover:bg-blue-700 dark:hover:bg-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200 font-medium flex justify-center gap-4"
    >
      Enviar mensaxe
      <Loader class="loader hidden" />
      <Check class="check hidden" />
    </button>
  </form>
</div>

{/* Send form data and animate form */}
<script is:inline defer>
  {
    const form = document.querySelector("#contact-form");
    const loader = form.querySelector(".loader");
    const check = form.querySelector(".check");

    const startLoad = () => {
      loader.classList.remove("hidden");
      loader.classList.add("animate-spin");
    };

    const endLoad = () => {
      loader.classList.add("hidden");
      loader.classList.remove("animate-spin");

      check.classList.remove("hidden");
      check.classList.add("animate-bounce");
      setTimeout(() => check.classList.add("hidden"), 500);
    };

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      startLoad();

      try {
        const response = await fetch(
          "https://activepieces.gpul.org/api/v1/webhooks/0c0o5NPbtpg4ddEjWiD3p",
          {
            method: "POST",
            body: new FormData(form),
          }
        );
      } catch (error) {
        console.error(error);
      }

      endLoad();
    });
  }
</script>

{/* Set the subject of the select automatically from the url params */}
<script is:inline defer>
  {
    /** @type {HTMLSelectElement} */
    const select = document.querySelector("#subject select");

    const subjectParam =
      new URLSearchParams(document.location.search).get("asunto") ?? "";

    const options = [...select.options].map((option) => option.value);

    if (options.includes(subjectParam)) {
      select.value = subjectParam;
    }
  }
</script>

{/* React to subject changes */}
<script is:inline defer>
  {
    /** @type {HTMLSelectElement} */
    const select = document.querySelector("#subject select");
    /** @type {HTMLFormElement} */
    const form = document.querySelector("#contact-form");

    const formVariants = {
      default: ["name", "mail", "message"],
      socio: [
        "name",
        "surname",
        "phone",
        "mail",
        "dni",
        "birth",
        "address",
        "occupation",
        "udc-student",
      ],
    };

    const formConstants = ["subject", "privacy-policy", ""];

    const setFormElements = () => {
      const selected = select.value;
      const variant = formVariants[selected] ?? formVariants.default;

      for (const element of form.elements) {
        if (formConstants.includes(element.name)) continue;

        const needed = variant.includes(element.name);

        element.parentElement.classList.toggle("hidden", !needed);
        element.disabled = !needed;
      }
    };

    setFormElements();
    select.addEventListener("change", setFormElements);
  }
</script>
